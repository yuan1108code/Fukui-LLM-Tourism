# 地理位置感知搜尋功能實現說明

## 🎯 功能目標
實現 GPT-4o-mini 在推薦景點時能夠考慮地理位置的接近性，優先推薦同一個市區或距離相對較近的景點。

## 📝 實現內容

### 1. 新增地理距離計算功能
在 `src/Vector_Database/ChromaDB_v1.py` 中新增：
- `calculate_distance()` 靜態方法：使用 Haversine 公式計算兩點間距離
- 支援精確的地球球面距離計算

### 2. 地點資訊提取功能
- `extract_location_from_query()` 方法：從使用者查詢中識別城市名稱
- 自動載入地理資料並建立城市座標映射
- 優先使用 Google Maps 精確座標

### 3. 地理位置感知搜尋
- `search_similar_with_location()` 方法：結合語義搜尋和地理位置
- 支援同城市加權（預設2.0倍權重）
- 支援距離閾值過濾（預設20公里內）
- 智能排序：優先同城市，其次按距離遠近

### 4. 改進 GPT 提示
- 更新系統提示，強調地理位置優先級
- 新增地理分組建議
- 鼓勵創建高效的旅遊路線規劃

### 5. API 整合
- 修改 `backend/app.py` 的聊天 API
- 預設使用地理位置感知搜尋
- 保持向後相容性

## 🔧 使用方式

### 基本搜尋（考慮地理位置）
```python
results = chroma_manager.search_similar_with_location(
    "福井市有什麼景點？", 
    n_results=5,
    same_city_weight=2.0,
    distance_threshold_km=20.0
)
```

### GPT 問答（啟用地理感知）
```python
answer = chroma_manager.ask_gpt(
    question="推薦大野市的觀光地點",
    use_location_aware_search=True
)
```

## 📊 功能特色

1. **智能地理識別**：自動從查詢中識別城市/地點
2. **多層次排序**：語義相關性 + 地理接近性
3. **同城市優先**：同城市景點獲得更高權重
4. **距離過濾**：只推薦合理距離內的景點
5. **路線優化**：GPT 會建議地理上連貫的行程

## 🧪 測試功能

建立了 `test_location_aware_search.py` 測試腳本：
- 測試距離計算精度
- 驗證地理位置搜尋結果
- 比較不同查詢的地理感知效果

## 🎯 預期效果

使用者詢問景點推薦時，系統會：
1. 識別查詢中的地點資訊
2. 優先返回同一城市的相關景點
3. 按地理距離排序其他相關景點
4. GPT 提供地理分組的推薦建議
5. 建議高效的旅遊路線規劃

這樣能夠大大提升旅遊建議的實用性和可行性！
